<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>üìÖ Calend√°rio de Reservas ‚Ä¢ Cozinha</title>
<style>
:root{
  --bg:#0b0f19;--card:#151d2f;--text:#f8fafc;--muted:#94a3b8;--line:#243043;
  --accent:#ff8f1f;--accent2:#ffb347;--radius:14px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:Inter,system-ui,sans-serif;
  background:linear-gradient(180deg,#0a0f1b,#0b0f19 80%);
  color:var(--text);min-height:100vh;padding:20px;
  display:flex;flex-direction:column;align-items:center;
}
h1{color:var(--accent);margin-bottom:20px;text-align:center}
.card{
  background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
  padding:16px;max-width:1000px;width:100%;
}
.cal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.cal-title{font-weight:900}
.toolbar{display:flex;gap:6px}
.btn{background:#0f172a;color:var(--text);border:1px dashed var(--line);padding:6px 10px;border-radius:8px;cursor:pointer}
.btn:hover{border-color:var(--accent)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.cal-dow{font-size:.9rem;color:var(--muted);text-align:center}
.cal-day{border:1px solid var(--line);border-radius:10px;min-height:100px;padding:8px;position:relative;transition:.15s}
.cal-day:hover{transform:translateY(-2px);border-color:var(--accent)}
.cal-day.out{opacity:.4}
.num{font-weight:700}
.tags{position:absolute;bottom:6px;left:6px;right:6px;display:flex;flex-wrap:wrap;gap:4px}
.tag{font-size:.7rem;padding:3px 6px;border-radius:999px;background:#0f172a;border:1px solid var(--line)}
.t-pend{background:#3c2a07;color:#ffcd73}
.t-done{background:#0e2a12;color:#9ef7b8}
.t-vip{background:#0b274a;color:#86baff}
.t-outros{background:#3a230e;color:#ffbf86}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:flex-end;backdrop-filter:blur(3px)}
.modal.show{display:flex}
.sheet{background:#151d2f;width:100%;max-height:80vh;overflow:auto;border-radius:16px 16px 0 0;border:1px solid var(--line)}
.sheet h3{margin:16px;color:var(--accent2)}
.res-item{border:1px solid var(--line);border-radius:10px;padding:10px;margin:10px;background:#0f172a}
.res-item .name{font-weight:700}
.res-item .meta{font-size:.9rem;color:var(--muted)}
.alert{margin-top:20px;font-size:.9rem;color:#ffb347;text-align:center}
</style>
</head>
<body>
<h1>üìÖ Calend√°rio de Reservas</h1>
<div class="card">
  <div class="cal-head">
    <div class="cal-title" id="calTitle">Carregando...</div>
    <div class="toolbar">
      <button class="btn" id="prev">‚óÄ</button>
      <button class="btn" id="today">Hoje</button>
      <button class="btn" id="next">‚ñ∂</button>
    </div>
  </div>
  <div class="cal-grid" id="calDow"></div>
  <div class="cal-grid" id="calGrid"></div>
</div>
<div id="alert" class="alert"></div>

<div class="modal" id="dayModal">
  <div class="sheet">
    <h3 id="modalTitle">Reservas do dia</h3>
    <div id="modalList"></div>
  </div>
</div>

<script>
/* ===== Prote√ß√£o de acesso ===== */
if(localStorage.getItem("acessoCozinha")!=="ok"){
  window.location.href="index.html";
}

/* ===== Config ===== */
const endpoint="https://script.google.com/macros/s/AKfycbwE-0oOl4wGHz7gFXHIgYHNihCTW4-uzUjGv_iLvPSWX1sma8pi9eJIwx1K4grFOILj/exec";
const $=(s,el=document)=>el.querySelector(s);
const monthNames=['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
const dow=['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'];
const state={mes:(new Date()).getMonth(),ano:(new Date()).getFullYear(),reservas:[]};
const ymd=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;

/* ===== Interface ===== */
const calTitle=$('#calTitle'),calDow=$('#calDow'),calGrid=$('#calGrid');
calDow.innerHTML=dow.map(d=>`<div class='cal-dow'>${d}</div>`).join('');
const alertBox=$('#alert');

/* ===== Fun√ß√µes ===== */
function parseDataHora(v){
  if(!v) return null;
  if(v.includes('/')){ // dd/mm/yyyy hh:mm
    const [data,hora] = v.split(' ');
    const [dia,mes,ano]=data.split('/');
    return new Date(`${ano}-${mes}-${dia}T${hora||'00:00'}`);
  }
  return new Date(v);
}

async function listar(ano,mes){
  const url=`${endpoint}?acao=listar&ano=${ano}&mes=${mes+1}`;
  console.log("Buscando:",url);
  try{
    const res=await fetch(url);
    const data=await res.json();
    console.log("Dados recebidos:",data);
    if(Array.isArray(data)&&data.length){
      alertBox.textContent="";
      return data;
    }else{
      alertBox.textContent="Nenhuma reserva encontrada neste m√™s.";
      return [];
    }
  }catch(e){
    console.error("Erro:",e);
    alertBox.textContent="‚ùå Erro ao carregar dados do servidor.";
    return [];
  }
}

function buildCalendar(){
  const {mes,ano}=state;
  calTitle.textContent=`${monthNames[mes]} de ${ano}`;
  calGrid.innerHTML='';
  const first=new Date(ano,mes,1);
  const start=new Date(first);
  start.setDate(1-((first.getDay()+7)%7));
  for(let i=0;i<42;i++){
    const d=new Date(start);d.setDate(start.getDate()+i);
    const inMonth=d.getMonth()===mes;
    const cell=document.createElement('div');
    cell.className='cal-day'+(inMonth?'':' out');
    const items=state.reservas.filter(r=>{
      const dt=parseDataHora(r.datahora||r.DataHora||r.data||r.Data);
      return dt && ymd(dt)===ymd(d);
    });
    const groups=new Map();
    for(const r of items){
      const k=(r.mesa||r.Mesa||'‚Äî').toUpperCase();
      groups.set(k,{label:r.mesa||r.Mesa||'‚Äî',count:(groups.get(k)?.count||0)+1});
    }
    const tags=[...groups.entries()].map(([k,v])=>{
      const vip=k.includes('VIP');const css=vip?'t-vip':'t-outros';
      return `<span class='tag ${css}'>${v.count} ${v.label}</span>`;
    }).join('');
    const pend=items.filter(r=>(r.status||r.Status||'Pendente')!=='Conclu√≠da').length;
    const done=items.filter(r=>(r.status||r.Status)==='Conclu√≠da').length;
    cell.innerHTML=`<div class='num'>${d.getDate()}</div>
      <div class='tags'>${tags}${pend?`<span class='tag t-pend'>Pend: ${pend}</span>`:''}${done?`<span class='tag t-done'>Conc: ${done}</span>`:''}</div>`;
    cell.addEventListener('click',()=>abrirModal(d,items));
    calGrid.appendChild(cell);
  }
}

function abrirModal(date,items){
  const m=$('#dayModal'),list=$('#modalList');
  $('#modalTitle').textContent=`Reservas de ${date.toLocaleDateString('pt-BR')}`;
  if(!items.length){
    list.innerHTML="<div class='res-item'><div class='meta'>Nenhuma reserva neste dia.</div></div>";
  }else{
    list.innerHTML=items.map(r=>{
      const dt=parseDataHora(r.datahora||r.DataHora);
      return `<div class='res-item'>
        <div class='name'>${r.nome||r.Nome||'‚Äî'}</div>
        <div class='meta'>${dt?dt.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}):'‚Äî'} ‚Ä¢ ${r.mesa||r.Mesa||'‚Äî'} ‚Ä¢ ${r.pessoas||r.Pessoas||'0'} pessoa(s)</div>
        <div class='meta'><b>Status:</b> ${r.status||r.Status||'Pendente'}</div>
        <div class='meta'><b>Card√°pio:</b> ${r.cardapio||r.Cardapio||'‚Äî'}</div>
        <div class='meta'><b>Obs:</b> ${r.observacoes||r.Observacoes||'‚Äî'}</div>
      </div>`;
    }).join('');
  }
  m.classList.add("show");
}
$('#dayModal').addEventListener('click',e=>{if(e.target.id==='dayModal')e.target.classList.remove('show')});

/* ===== Navega√ß√£o ===== */
$('#prev').addEventListener('click',()=>{const d=new Date(state.ano,state.mes-1);state.mes=d.getMonth();state.ano=d.getFullYear();refresh();});
$('#next').addEventListener('click',()=>{const d=new Date(state.ano,state.mes+1);state.mes=d.getMonth();state.ano=d.getFullYear();refresh();});
$('#today').addEventListener('click',()=>{const t=new Date();state.mes=t.getMonth();state.ano=t.getFullYear();refresh();});

/* ===== Atualizar ===== */
async function refresh(){
  state.reservas=await listar(state.ano,state.mes);
  buildCalendar();
}
refresh();
</script>
</body>
</html>
